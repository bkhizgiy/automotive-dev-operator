apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: operator-deployment-test
spec:
  description: Test operator deployment and basic functionality
  params:
    - name: SNAPSHOT
      description: The snapshot of the application
      type: string
    - name: NAMESPACE
      description: Target namespace for testing
      type: string
      default: automotive-dev-operator-test
  
  tasks:
    - name: provision-cluster
      taskRef:
        resolver: bundles
        params:
          - name: bundle
            value: quay.io/konflux-ci/tekton-catalog/task-provision-env:0.1
          - name: name
            value: provision-env
          - name: kind
            value: task
      params:
        - name: SNAPSHOT
          value: $(params.SNAPSHOT)
    
    - name: deploy-operator
      runAfter:
        - provision-cluster
      taskSpec:
        params:
          - name: SNAPSHOT
          - name: NAMESPACE
        steps:
          - name: install-operator
            image: quay.io/openshift/origin-cli:latest
            script: |
              #!/bin/bash
              set -ex
              
              # Parse snapshot to get operator image
              OPERATOR_IMAGE=$(echo '$(params.SNAPSHOT)' | jq -r '.components[] | select(.name=="automotive-dev-operator") | .containerImage')
              
              echo "Installing operator with image: ${OPERATOR_IMAGE}"
              
              # Create namespace
              oc create namespace $(params.NAMESPACE) --dry-run=client -o yaml | oc apply -f -
              
              # Apply CRDs
              oc apply -f https://raw.githubusercontent.com/centos-automotive-suite/automotive-dev-operator/main/config/crd/bases/
              
              # Deploy operator
              cat <<EOF | oc apply -f -
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: automotive-dev-operator
                namespace: $(params.NAMESPACE)
              spec:
                replicas: 1
                selector:
                  matchLabels:
                    app: automotive-dev-operator
                template:
                  metadata:
                    labels:
                      app: automotive-dev-operator
                  spec:
                    containers:
                    - name: manager
                      image: ${OPERATOR_IMAGE}
                      ports:
                      - containerPort: 8443
                        name: webhook-server
                        protocol: TCP
                      - containerPort: 8080
                        name: metrics
                        protocol: TCP
              EOF
              
              # Wait for operator to be ready
              oc rollout status deployment/automotive-dev-operator -n $(params.NAMESPACE) --timeout=5m
      params:
        - name: SNAPSHOT
          value: $(params.SNAPSHOT)
        - name: NAMESPACE
          value: $(params.NAMESPACE)
    
    - name: test-operator-health
      runAfter:
        - deploy-operator
      taskSpec:
        params:
          - name: NAMESPACE
        steps:
          - name: check-health
            image: quay.io/openshift/origin-cli:latest
            script: |
              #!/bin/bash
              set -ex
              
              # Check operator pod is running
              oc get pods -n $(params.NAMESPACE) -l app=automotive-dev-operator
              
              POD_STATUS=$(oc get pods -n $(params.NAMESPACE) -l app=automotive-dev-operator -o jsonpath='{.items[0].status.phase}')
              if [ "$POD_STATUS" != "Running" ]; then
                echo "ERROR: Operator pod is not running: $POD_STATUS"
                exit 1
              fi
              
              echo "SUCCESS: Operator is running"
      params:
        - name: NAMESPACE
          value: $(params.NAMESPACE)
    
    - name: test-cr-creation
      runAfter:
        - test-operator-health
      taskSpec:
        params:
          - name: NAMESPACE
        steps:
          - name: create-test-cr
            image: quay.io/openshift/origin-cli:latest
            script: |
              #!/bin/bash
              set -ex
              
              # Create a test OperatorConfig CR
              cat <<EOF | oc apply -f -
              apiVersion: automotive.sdv.cloud.redhat.com/v1
              kind: OperatorConfig
              metadata:
                name: test-config
                namespace: $(params.NAMESPACE)
              spec:
                defaultImageBuilder: "quay.io/centos-automotive-suite/automotive-image-builder:latest"
              EOF
              
              # Wait for CR to be processed
              sleep 5
              
              # Verify CR exists and was processed
              oc get operatorconfig test-config -n $(params.NAMESPACE) -o yaml
              
              echo "SUCCESS: Custom resource created and processed"
      params:
        - name: NAMESPACE
          value: $(params.NAMESPACE)
    
    - name: cleanup
      runAfter:
        - test-cr-creation
      taskSpec:
        params:
          - name: NAMESPACE
        steps:
          - name: delete-namespace
            image: quay.io/openshift/origin-cli:latest
            script: |
              #!/bin/bash
              set -x
              
              # Clean up test namespace
              oc delete namespace $(params.NAMESPACE) --timeout=2m || true
              
              echo "Cleanup completed"
      params:
        - name: NAMESPACE
          value: $(params.NAMESPACE)
  
  results:
    - name: TEST_OUTPUT
      description: Test execution summary
      value: "Operator deployment test completed successfully"

