apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-csv-digests
  annotations:
    tekton.dev/displayName: Update CSV with Image Digests
    tekton.dev/categories: OLM
    tekton.dev/tags: operator, olm, csv
spec:
  description: Updates ClusterServiceVersion with SHA digest image references for disconnected environment support
  params:
    - name: operator-image-url
      description: Operator image URL
      type: string
    - name: operator-image-digest
      description: Operator image SHA digest
      type: string
    - name: webui-image-url
      description: WebUI image URL
      type: string
      default: ""
    - name: webui-image-digest
      description: WebUI image SHA digest
      type: string
      default: ""
    - name: csv-path
      description: Path to ClusterServiceVersion YAML file
      type: string
      default: bundle/manifests/automotive-dev-operator.clusterserviceversion.yaml
    - name: git-user-name
      description: Git user name for commit
      type: string
      default: "Konflux Bot"
    - name: git-user-email
      description: Git user email for commit
      type: string
      default: "konflux-bot@redhat.com"
  
  workspaces:
    - name: source
      description: Workspace containing the source code
  
  results:
    - name: updated
      description: Whether the CSV was updated (true/false)
  
  steps:
    - name: update-csv
      image: quay.io/konflux-ci/yq:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/bash
        set -ex
        
        CSV_FILE="$(params.csv-path)"
        
        if [ ! -f "${CSV_FILE}" ]; then
          echo "ERROR: CSV file not found at ${CSV_FILE}"
          exit 1
        fi
        
        echo "Updating CSV file: ${CSV_FILE}"
        
        # Build the full image reference with digest
        OPERATOR_IMAGE_REF="$(params.operator-image-url)@$(params.operator-image-digest)"
        
        echo "Operator image reference: ${OPERATOR_IMAGE_REF}"
        
        # Update the operator image in the CSV
        # This updates the deployment spec in the CSV
        yq eval ".spec.install.spec.deployments[].spec.template.spec.containers[] |= 
          select(.name == \"manager\").image = \"${OPERATOR_IMAGE_REF}\"" \
          -i "${CSV_FILE}"
        
        # If WebUI image is provided, update it too
        if [ -n "$(params.webui-image-digest)" ]; then
          WEBUI_IMAGE_REF="$(params.webui-image-url)@$(params.webui-image-digest)"
          echo "WebUI image reference: ${WEBUI_IMAGE_REF}"
          
          yq eval ".spec.install.spec.deployments[].spec.template.spec.containers[] |= 
            select(.name == \"webui\").image = \"${WEBUI_IMAGE_REF}\"" \
            -i "${CSV_FILE}"
        fi
        
        # Update related images section for disconnected support
        yq eval ".spec.relatedImages += [{\"name\": \"manager\", \"image\": \"${OPERATOR_IMAGE_REF}\"}]" \
          -i "${CSV_FILE}"
        
        if [ -n "$(params.webui-image-digest)" ]; then
          WEBUI_IMAGE_REF="$(params.webui-image-url)@$(params.webui-image-digest)"
          yq eval ".spec.relatedImages += [{\"name\": \"webui\", \"image\": \"${WEBUI_IMAGE_REF}\"}]" \
            -i "${CSV_FILE}"
        fi
        
        # Remove duplicates in relatedImages
        yq eval '.spec.relatedImages |= unique_by(.name)' -i "${CSV_FILE}"
        
        echo "CSV updated successfully"
        echo "true" > $(results.updated.path)
    
    - name: commit-changes
      image: registry.access.redhat.com/ubi9/git-core:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/bash
        set -ex
        
        CSV_FILE="$(params.csv-path)"
        
        # Configure git
        git config user.name "$(params.git-user-name)"
        git config user.email "$(params.git-user-email)"
        
        # Check if there are changes
        if git diff --quiet "${CSV_FILE}"; then
          echo "No changes to commit"
          exit 0
        fi
        
        # Stage and commit changes
        git add "${CSV_FILE}"
        git commit -m "Update CSV with image SHA digests

        Updated by Konflux automation
        - Operator image: $(params.operator-image-url)@$(params.operator-image-digest)
        $(if [ -n "$(params.webui-image-digest)" ]; then echo "- WebUI image: $(params.webui-image-url)@$(params.webui-image-digest)"; fi)"
        
        echo "Changes committed successfully"

